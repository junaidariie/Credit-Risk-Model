<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RiskGuard AI: Credit Risk Modelling</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-container {
            background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            margin-bottom: 2rem;
            text-align: center;
            border: 1px solid #2a2a2a;
        }

        .header-title {
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
        }

        .header-subtitle {
            color: #9a9a9a;
            font-size: 1.1rem;
            margin-top: 0.5rem;
        }

        .alert-banner {
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #e0e0e0;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            border-left: 4px solid #4a4a4a;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-toggle-btn {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            color: white;
            border: 1px solid #3a3a3a;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .info-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
            border-color: #4a4a4a;
            background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
        }

        .info-box {
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            color: #d0d0d0;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            border-left: 4px solid #4a4a4a;
            display: none;
        }

        .info-box.show {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .section-card {
            background: #1a1a1a;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            border-left: 4px solid #3a3a3a;
            border: 1px solid #2a2a2a;
        }

        .section-title {
            color: #f0f0f0;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #9a9a9a;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.8rem;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
            background: #0f0f0f;
            color: #e0e0e0;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4a4a4a;
            box-shadow: 0 0 0 3px rgba(74, 74, 74, 0.2);
        }

        .metric-card {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            padding: 1.2rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease;
            margin-top: 1rem;
            border: 1px solid #3a3a3a;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 0.5rem;
            color: #9a9a9a;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #e0e0e0;
        }

        .analyze-btn {
            width: 100%;
            background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
            color: white;
            font-weight: 600;
            border: 1px solid #4a4a4a;
            border-radius: 12px;
            padding: 1.2rem;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            margin: 2rem 0;
        }

        .analyze-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.7);
            border-color: #5a5a5a;
            background: linear-gradient(135deg, #4a4a4a 0%, #3a3a3a 100%);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .result-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            margin: 1.5rem 0;
            display: none;
            border: 1px solid #2a2a2a;
        }

        .result-card.show {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .result-item {
            background: rgba(42, 42, 42, 0.5);
            padding: 1.5rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid #3a3a3a;
        }

        .result-item-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 0.5rem;
            color: #9a9a9a;
        }

        .result-item-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #e0e0e0;
        }

        .advisor-box {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1.5rem;
            border-left: 4px solid #4a4a4a;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid #3a3a3a;
        }

        .audio-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            align-items: center;
        }

        .audio-btn {
            background: linear-gradient(135deg, #4a4a4a 0%, #3a3a3a 100%);
            color: white;
            border: 1px solid #5a5a5a;
            padding: 0.7rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .audio-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
            background: linear-gradient(135deg, #5a5a5a 0%, #4a4a4a 100%);
        }

        .audio-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .audio-btn.stop {
            background: linear-gradient(135deg, #5a5a5a 0%, #4a4a4a 100%);
            border-color: #6a6a6a;
        }

        .chat-section {
            margin-top: 2rem;
            display: none;
        }

        .chat-section.show {
            display: block;
        }

        .chat-container {
            background: #0f0f0f;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 1rem;
            border: 1px solid #2a2a2a;
        }

        .chat-bubble-user {
            background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
            color: white;
            padding: 12px 18px;
            border-radius: 18px 18px 4px 18px;
            margin: 8px 0 8px auto;
            max-width: 70%;
            text-align: right;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            animation: slideInRight 0.3s ease-out;
            border: 1px solid #4a4a4a;
        }

        .chat-bubble-bot {
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            color: #d0d0d0;
            padding: 12px 18px;
            border-radius: 18px 18px 18px 4px;
            margin: 8px auto 8px 0;
            max-width: 75%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            animation: slideInLeft 0.3s ease-out;
            position: relative;
            padding-bottom: 3rem;
        }

        .chat-bubble-thinking {
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            color: #9a9a9a;
            padding: 12px 18px;
            border-radius: 18px 18px 18px 4px;
            margin: 8px auto 8px 0;
            max-width: 75%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            animation: slideInLeft 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .bot-text {
            display: block;
            line-height: 1.6;
        }

        .thinking-text {
            font-style: italic;
            color: #9a9a9a;
        }

        .dots-loader {
            display: flex;
            gap: 0.3rem;
            align-items: center;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #5a5a5a;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .tts-control {
            position: absolute;
            bottom: 8px;
            right: 12px;
            background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
            border: 1px solid #4a4a4a;
            color: #d0d0d0;
            cursor: pointer;
            font-size: 1rem;
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .tts-control:hover {
            background: linear-gradient(135deg, #4a4a4a 0%, #3a3a3a 100%);
            border-color: #5a5a5a;
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.5);
        }

        .tts-control:active {
            transform: translateY(0);
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .chat-input-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.8rem;
            border-radius: 10px;
            border: 1px solid #3a3a3a;
            background: #0f0f0f;
            color: #e0e0e0;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: #4a4a4a;
            box-shadow: 0 0 0 3px rgba(74, 74, 74, 0.2);
        }

        .mic-btn {
            background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
            color: white;
            border: 1px solid #4a4a4a;
            padding: 0.8rem 1.3rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .mic-btn:hover {
            transform: scale(1.08);
            background: linear-gradient(135deg, #4a4a4a 0%, #3a3a3a 100%);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .mic-btn.recording {
            background: linear-gradient(135deg, #5a5a5a 0%, #4a4a4a 100%);
            animation: pulse 1s infinite;
            border-color: #6a6a6a;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .button-row {
            display: flex;
            gap: 1rem;
        }

        .send-btn {
            flex: 3;
            background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
            color: white;
            border: 1px solid #4a4a4a;
            padding: 0.9rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            border-color: #5a5a5a;
            background: linear-gradient(135deg, #4a4a4a 0%, #3a3a3a 100%);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .clear-btn {
            flex: 1;
            background: linear-gradient(135deg, #4a3a3a 0%, #3a2a2a 100%);
            color: white;
            border: 1px solid #5a4a4a;
            padding: 0.9rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .clear-btn:hover {
            transform: translateY(-2px);
            border-color: #6a5a5a;
            background: linear-gradient(135deg, #5a4a4a 0%, #4a3a3a 100%);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
        }

        .chat-container::-webkit-scrollbar {
            width: 8px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: #0a0a0a;
            border-radius: 10px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: #3a3a3a;
            border-radius: 10px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #4a4a4a;
        }

        .footer {
            text-align: center;
            color: #6a6a6a;
            font-size: 0.9rem;
            margin-top: 3rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .success-message {
            background: linear-gradient(135deg, #2a3a2a 0%, #1a2a1a 100%);
            color: #b0d0b0;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            display: none;
            border: 1px solid #3a4a3a;
        }

        .success-message.show {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        .error-message {
            background: linear-gradient(135deg, #3a2a2a 0%, #2a1a1a 100%);
            color: #d0b0b0;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            display: none;
            border: 1px solid #4a3a3a;
        }

        .error-message.show {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .header-title {
                font-size: 1.8rem;
            }

            body {
                padding: 1rem;
            }

            .chat-bubble-user,
            .chat-bubble-bot {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header-container">
            <h1 class="header-title">üõ°Ô∏è RiskGuard AI</h1>
            <p class="header-subtitle">Advanced AI-Powered Credit Risk Assessment Platform</p>
        </div>

        <!-- Alert Banner -->
        <div class="alert-banner">
            ‚ö†Ô∏è <strong>Note:</strong> First request may take up to 30-60 seconds due to (API cold start).
        </div>

        <!-- Info Toggle -->
        <button class="info-toggle-btn" onclick="toggleInfo()">‚ÑπÔ∏è How It Works</button>

        <div class="info-box" id="infoBox">
            <h4>üìä About RiskGuard AI</h4>
            <p><strong>What we analyze:</strong></p>
            <ul>
                <li>Personal financial profile and credit history</li>
                <li>Loan-to-income ratio and debt burden</li>
                <li>Payment patterns and delinquency records</li>
                <li>Credit utilization and account management</li>
            </ul>
            <p><strong>Our AI provides:</strong></p>
            <ul>
                <li>Default probability predictions</li>
                <li>Credit score assessment</li>
                <li>Risk rating classification</li>
                <li>Personalized recommendations</li>
            </ul>
        </div>

        <!-- Messages -->
        <div class="success-message" id="successMessage"></div>
        <div class="error-message" id="errorMessage"></div>

        <!-- Input Form -->
        <div class="form-grid">
            <div class="section-card">
                <div class="section-title">üë§ Personal & Loan Information</div>

                <div class="form-group">
                    <label>Age</label>
                    <input type="number" id="age" value="28" min="18" max="100">
                </div>

                <div class="form-group">
                    <label>Annual Income (‚Çπ)</label>
                    <input type="number" id="income" value="1200000" min="0" step="50000">
                </div>

                <div class="form-group">
                    <label>Loan Amount (‚Çπ)</label>
                    <input type="number" id="loanAmount" value="2500000" min="0" step="100000">
                </div>

                <div class="form-group">
                    <label>Loan Tenure (months)</label>
                    <input type="number" id="loanTenure" value="36" min="0" max="480">
                </div>

                <div class="form-group">
                    <label>Loan Purpose</label>
                    <select id="loanPurpose">
                        <option value="Education">Education</option>
                        <option value="Home">Home</option>
                        <option value="Auto">Auto</option>
                        <option value="Personal">Personal</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Residence Type</label>
                    <select id="residenceType">
                        <option value="Owned">Owned</option>
                        <option value="Rented">Rented</option>
                        <option value="Mortgage">Mortgage</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Loan Type</label>
                    <select id="loanType">
                        <option value="Secured">Secured</option>
                        <option value="Unsecured">Unsecured</option>
                    </select>
                </div>

                <div class="metric-card">
                    <div class="metric-label">Loan-to-Income Ratio</div>
                    <div class="metric-value" id="ltiRatio">2.08x</div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-title">üí≥ Credit Profile</div>

                <div class="form-group">
                    <label>Average Days Past Due</label>
                    <input type="number" id="avgDpd" value="20" min="0" max="200">
                </div>

                <div class="form-group">
                    <label>Delinquency Ratio (%)</label>
                    <input type="number" id="delinquencyRatio" value="30" min="0" max="100">
                </div>

                <div class="form-group">
                    <label>Credit Utilization (%)</label>
                    <input type="number" id="creditUtilization" value="30" min="0" max="100">
                </div>

                <div class="form-group">
                    <label>Open Loan Accounts</label>
                    <input type="number" id="openAccounts" value="2" min="0" max="20">
                </div>
            </div>
        </div>

        <!-- Analyze Button -->
        <button class="analyze-btn" id="analyzeBtn" onclick="analyzeCredit()">
            üîç Analyze Credit Risk
        </button>

        <!-- Results -->
        <div class="result-card" id="resultCard">
            <h3 style="margin-top:0; color:white;">üìä Assessment Results</h3>
            <div class="result-grid">
                <div class="result-item">
                    <div class="result-item-label">Default Probability</div>
                    <div class="result-item-value" id="probability">--</div>
                </div>
                <div class="result-item">
                    <div class="result-item-label">Credit Score</div>
                    <div class="result-item-value" id="creditScore">--</div>
                </div>
                <div class="result-item">
                    <div class="result-item-label">Risk Rating</div>
                    <div class="result-item-value" id="rating">--</div>
                </div>
            </div>

            <div class="advisor-box">
                <h4>ü§ñ AI Credit Advisor Insights</h4>
                <p id="advisorText">--</p>
                <div class="audio-controls">
                    <button class="audio-btn" id="playAdvisorBtn" onclick="playAdvisorAudio()" disabled>
                        <span>üîä</span> Listen to Insights
                    </button>
                    <button class="audio-btn stop" id="stopAdvisorBtn" onclick="stopAudio()" style="display: none;">
                        <span>‚èπÔ∏è</span> Stop
                    </button>
                </div>
            </div>
        </div>

        <!-- Chat Section -->
        <div class="chat-section section-card" id="chatSection">
            <div class="section-title">üí¨ Interactive Loan Chat Assistant</div>

            <div class="chat-container" id="chatContainer"></div>

            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" 
                       placeholder="e.g., How can I improve my credit score?" 
                       onkeypress="handleChatKeypress(event)">
                <button class="mic-btn" id="micBtn" onclick="toggleMicrophone()">üé§</button>
            </div>

            <div class="button-row">
                <button class="send-btn" onclick="sendMessage()">üì§ Send Message</button>
                <button class="clear-btn" onclick="clearChat()">üóëÔ∏è Clear Chat</button>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>üõ°Ô∏è RiskGuard AI ¬© 2025 | Powered by Advanced Machine Learning</p>
            <p style="font-size: 0.8rem;">For demonstration purposes only. Not financial advice.</p>
        </div>
    </div>

    <script>
        // Global variables
        let threadId = generateUUID();
        let analysisData = null;
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let currentAudio = null;
        let currentBotAudios = {}; // Store audio objects for each bot message

        // Generate UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Toggle info box
        function toggleInfo() {
            const infoBox = document.getElementById('infoBox');
            infoBox.classList.toggle('show');
        }

        // Update loan-to-income ratio
        function updateLTI() {
            const income = parseFloat(document.getElementById('income').value) || 1;
            const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
            const ratio = (loanAmount / income).toFixed(2);
            document.getElementById('ltiRatio').textContent = ratio + 'x';
        }

        // Add event listeners for input changes
        document.getElementById('income').addEventListener('input', updateLTI);
        document.getElementById('loanAmount').addEventListener('input', updateLTI);

        // Show success message
        function showSuccess(message) {
            const successMsg = document.getElementById('successMessage');
            successMsg.textContent = message;
            successMsg.classList.add('show');
            setTimeout(() => successMsg.classList.remove('show'), 5000);
        }

        // Show error message
        function showError(message) {
            const errorMsg = document.getElementById('errorMessage');
            errorMsg.textContent = message;
            errorMsg.classList.add('show');
            setTimeout(() => errorMsg.classList.remove('show'), 5000);
        }

        // Add thinking indicator
        function addThinkingBubble() {
            const container = document.getElementById('chatContainer');
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble-thinking';
            bubble.id = 'thinkingBubble';

            bubble.innerHTML = `
                <span class="thinking-text">ü§ñ Assistant is thinking</span>
                <div class="dots-loader">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            `;

            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;

            return bubble;
        }

        // Remove thinking indicator
        function removeThinkingBubble() {
            const bubble = document.getElementById('thinkingBubble');
            if (bubble) {
                bubble.remove();
            }
        }

        // Analyze credit risk
        async function analyzeCredit() {
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Analyzing...';

            const payload = {
                age: parseInt(document.getElementById('age').value),
                income: parseFloat(document.getElementById('income').value),
                loan_amount: parseFloat(document.getElementById('loanAmount').value),
                loan_tenure_months: parseInt(document.getElementById('loanTenure').value),
                avg_dpd_per_delinquency: parseFloat(document.getElementById('avgDpd').value),
                delinquency_ratio: parseFloat(document.getElementById('delinquencyRatio').value),
                credit_utilization_ratio: parseFloat(document.getElementById('creditUtilization').value),
                num_open_accounts: parseInt(document.getElementById('openAccounts').value),
                residence_type: document.getElementById('residenceType').value,
                loan_purpose: document.getElementById('loanPurpose').value,
                loan_type: document.getElementById('loanType').value
            };

            try {
                const response = await fetch('https://junaid17-credit-risk-api.hf.space/predict_credit_risk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const result = await response.json();
                analysisData = result;

                // Display results
                document.getElementById('probability').textContent = 
                    (result.probability * 100).toFixed(2) + '%';
                document.getElementById('creditScore').textContent = result.credit_score;
                document.getElementById('rating').textContent = result.rating;
                document.getElementById('advisorText').textContent = result.advisor_response;

                document.getElementById('resultCard').classList.add('show');
                document.getElementById('chatSection').classList.add('show');
                document.getElementById('playAdvisorBtn').disabled = false;

                showSuccess('‚úÖ Analysis complete! You can now chat with our AI assistant below.');

            } catch (error) {
                showError('‚ùå Request failed: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîç Analyze Credit Risk';
            }
        }

        // Play advisor audio (TTS)
        async function playAdvisorAudio() {
            const text = document.getElementById('advisorText').textContent;
            const playBtn = document.getElementById('playAdvisorBtn');
            const stopBtn = document.getElementById('stopAdvisorBtn');

            playBtn.disabled = true;
            playBtn.innerHTML = '<span class="loading"></span> Generating...';

            try {
                const response = await fetch('https://junaid17-credit-risk-api.hf.space/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });

                if (!response.ok) throw new Error(`TTS Error: ${response.status}`);

                const blob = await response.blob();
                const audioUrl = URL.createObjectURL(blob);

                // Stop any currently playing audio
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }

                currentAudio = new Audio(audioUrl);

                currentAudio.play();
                playBtn.style.display = 'none';
                stopBtn.style.display = 'flex';

                currentAudio.onended = () => {
                    playBtn.innerHTML = '<span>üîä</span> Listen to Insights';
                    playBtn.disabled = false;
                    playBtn.style.display = 'flex';
                    stopBtn.style.display = 'none';
                    currentAudio = null;
                };

            } catch (error) {
                showError('‚ùå TTS failed: ' + error.message);
                playBtn.innerHTML = '<span>üîä</span> Listen to Insights';
                playBtn.disabled = false;
                playBtn.style.display = 'flex';
                stopBtn.style.display = 'none';
            }
        }

        // Stop audio playback
        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;

                const playBtn = document.getElementById('playAdvisorBtn');
                const stopBtn = document.getElementById('stopAdvisorBtn');

                playBtn.innerHTML = '<span>üîä</span> Listen to Insights';
                playBtn.disabled = false;
                playBtn.style.display = 'flex';
                stopBtn.style.display = 'none';
            }
        }

        // Play TTS for bot message
        async function playBotTTS(messageId, text, button) {
            try {
                // Stop if already playing
                if (currentBotAudios[messageId]) {
                    currentBotAudios[messageId].pause();
                    delete currentBotAudios[messageId];
                    button.innerHTML = 'üîä Play';
                    return;
                }

                button.innerHTML = '‚è≥ Wait';

                const response = await fetch('https://junaid17-credit-risk-api.hf.space/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });

                if (!response.ok) throw new Error(`TTS Error: ${response.status}`);

                const blob = await response.blob();
                const audioUrl = URL.createObjectURL(blob);
                const audio = new Audio(audioUrl);

                currentBotAudios[messageId] = audio;

                audio.play();
                button.innerHTML = '‚èπÔ∏è Stop';

                audio.onended = () => {
                    delete currentBotAudios[messageId];
                    button.innerHTML = 'üîä Play';
                };

            } catch (error) {
                showError('‚ùå TTS failed: ' + error.message);
                button.innerHTML = 'üîä Play';
            }
        }

        // Send chat message
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message || !analysisData) return;

            // Add user message
            addChatBubble('user', message);
            input.value = '';

            // Show thinking indicator
            const thinkingBubble = addThinkingBubble();

            // Prepare payload
            const payload = {
                thread_id: threadId,
                message: message,
                probability: analysisData.probability,
                credit_score: analysisData.credit_score,
                rating: analysisData.rating,
                advisor_reply: analysisData.advisor_response
            };

            try {
                const response = await fetch('https://junaid17-credit-risk-api.hf.space/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Chat Error: ${response.status}`);

                // Stream response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullText = '';
                let firstChunk = true;
                let botBubble = null;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    fullText += chunk;

                    // Remove thinking bubble and add bot bubble on first chunk
                    if (firstChunk) {
                        removeThinkingBubble();
                        botBubble = addChatBubble('bot', '');
                        const messageId = 'bot-' + Date.now();
                        botBubble.dataset.messageId = messageId;
                        firstChunk = false;
                    }

                    const textSpan = botBubble.querySelector('.bot-text');
                    textSpan.textContent = fullText;

                    // Auto scroll
                    const container = document.getElementById('chatContainer');
                    container.scrollTop = container.scrollHeight;
                }

            } catch (error) {
                removeThinkingBubble();
                showError('‚ùå Chat failed: ' + error.message);
            }
        }

        // Add chat bubble
        function addChatBubble(role, message) {
            const container = document.getElementById('chatContainer');
            const bubble = document.createElement('div');
            bubble.className = role === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot';

            if (role === 'user') {
                const prefix = 'You: ';
                bubble.innerHTML = `<strong>${prefix}</strong>${message}`;
            } else {
                const messageId = 'bot-' + Date.now();
                bubble.dataset.messageId = messageId;

                const textSpan = document.createElement('span');
                textSpan.className = 'bot-text';
                textSpan.innerHTML = `<strong>ü§ñ Assistant:</strong> ${message}`;

                const ttsButton = document.createElement('button');
                ttsButton.className = 'tts-control';
                ttsButton.innerHTML = 'üîä Play';
                ttsButton.onclick = () => {
                    const text = textSpan.textContent.replace('ü§ñ Assistant: ', '');
                    playBotTTS(messageId, text, ttsButton);
                };

                bubble.appendChild(textSpan);
                bubble.appendChild(ttsButton);
            }

            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;

            return bubble;
        }

        // Handle enter key in chat input
        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Clear chat
        function clearChat() {
            document.getElementById('chatContainer').innerHTML = '';
            threadId = generateUUID();

            // Stop all bot audios
            Object.values(currentBotAudios).forEach(audio => audio.pause());
            currentBotAudios = {};
        }

        // Toggle microphone (STT)
        async function toggleMicrophone() {
            const btn = document.getElementById('micBtn');

            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        await transcribeAudio(audioBlob);

                        // Stop all tracks
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    btn.classList.add('recording');
                    btn.textContent = '‚èπÔ∏è';

                } catch (error) {
                    showError('‚ùå Microphone access denied: ' + error.message);
                }

            } else {
                mediaRecorder.stop();
                isRecording = false;
                btn.classList.remove('recording');
                btn.textContent = 'üé§';
            }
        }

        // Transcribe audio (STT)
        async function transcribeAudio(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('file', audioBlob, 'audio.wav');

                const response = await fetch('https://junaid17-credit-risk-api.hf.space/stt', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error(`STT Error: ${response.status}`);

                const result = await response.json();
                document.getElementById('chatInput').value = result.text || result.transcription || '';

            } catch (error) {
                showError('‚ùå Transcription failed: ' + error.message);
            }
        }

        // Initialize
        window.onload = () => {
            updateLTI();
        };
    </script>
</body>
</html>
